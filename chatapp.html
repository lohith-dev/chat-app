<!DOCTYPE html>
    <html>
        <head>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.min.js"></script>
        </head>
        <style>
            body{ min-height: 100vh; margin:0; }
            body{
                display: flex;
                flex-direction: column;
            }
            .chatcont{
                 flex-grow: 1;
                 display: flex;
                 justify-content: center;
            }
            .list-group-item{
                border: none;
            }
            .header{
                text-align: center;
            }
            .chatbox{
                width: 500px;
            }
            .footcont{
                 min-height:50px
            }
            .list-group-item:nth-child(even) {
                background-color: #f0f0f0; /* Set the background color for even items */
            }
            .chatsend{
                width: 500px;
            }
        </style>
        <body >

      
         <script>

        const display=(data)=>{
            const parentDiv = document.getElementById('chatmessage');
            parentDiv.innerHTML='';
            data.forEach((chat, index) => {
                            const parentDiv = document.getElementById('chatmessage');

                            const childParagraph = document.createElement('li');
                            childParagraph.classList.add('list-group-item');
                            childParagraph.textContent = `${chat.message}`;
                            parentDiv.appendChild(childParagraph);
                          
                        });
              }

              async function showChatHistory(){

                    try{
                        let savingChats
                        const chats = localStorage.getItem('chatHistory');
                    console.log(typeof chats);
                       if(chats !== "undefined" && chats !== null){
                            console.log("gg");
                            const parsedChatHistory = JSON.parse(chats);
                            const latestStoredTimestamp = parsedChatHistory.length > 0 ? parsedChatHistory[parsedChatHistory.length - 1].date_time : 0;
                        
                            let data= await axios.get(`http://localhost:8000/msg?timestamp=${latestStoredTimestamp}`,{headers:{"Authorization":token}});
                            console.log(data.data.chat.length);
                            let slicedData=parsedChatHistory.slice(data.data.chat.length)
                            const apiChats = data.data.chat
                            const mergedChats = [...slicedData, ...apiChats];
                            savingChats = mergedChats.slice(-1000);
                      
                       }else{
                        
                        let data= await axios.get(`http://localhost:8000/msg?timestamp=${0}`,{headers:{"Authorization":token}});
                        // console.log(data.data.chat);
                        savingChats = data.data.chat;
                       }
                       localStorage.setItem("chatHistory", JSON.stringify(savingChats));
                       console.log(savingChats);
                         
                        display(savingChats)
                         
                         
                        }catch(err){
                            console.log(err);

                    }
              }

            const token = JSON.parse(localStorage.getItem('token'));               
                  window.onload =async()=>{

                    const form =document.querySelector("form");
                    const buton =document.querySelector("subut");
                    form.addEventListener('submit', e=>{
                        if(!form.checkValidity()){
                            e.preventDefault()
                        }
                        form.classList.add('was-validated')
                    })
                //   setInterval(async ()=>{
                //     try{
                //         let data= await axios.get('http://localhost:8000/msg',{headers:{"Authorization":token}});
                //         console.log(data);
                //             if(data.status===200){
                //                 display(data.data)
                //             }
                //         }catch(err){
                //             console.log(err);

                //         }
                //   },1000)
                     
                showChatHistory();
                    
                        
            }

    async function handleSubmit(event) {
            event.preventDefault(); 

            const msg = document.getElementById('chatmsg').value;
            console.log(msg);
        

            let msgData ={
                    message:msg,
            }

                try{
                   let data= await axios.post('http://localhost:8000/msg',msgData,{headers:{"Authorization":token}});
                    console.log(data);
                }catch(err){
                    showError(err.response.data.message)

                }
                

            }

                    </script>
           
                <div class="container chatcont" >
                    <!-- <div class="chat"> -->
                       <div class="chatbox ">
                        <div class="header">
                            <h2>Welcome to chat app</h2>
                        </div>
                        <ul class="list-group" id="chatmessage">
    
                            <!-- Add more list items as needed -->
                        </ul>
                       </div>
                    <!-- </div> -->
                </div>
                <footer class=" text-lg-start bg-body-tertiary text-muted ">
                    <section class="d-flex footr justify-content-center align-items-center p-4 border-bottom">
                    <form novalidate onSubmit="return handleSubmit(event)">
                       <div class="d-flex chatsend">
                      
                            <div class="form-group flex-grow-1">
                                <!-- <label for="exampleInputEmail1">Email address</label> -->
                                <input type="email" class="form-control" id="chatmsg" aria-describedby="emailHelp" placeholder="Enter the message">
                                <!-- <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small> -->
                            </div>
                            <input type="submit"  id ="sub-button" class="subut" value="Send">
                      
                       </div>
                    </form>
                    </section>
                </footer>
            
        </body>
</html>